// Code generated by iacg; DO NOT EDIT.
package teo

import (
	"context"
	"fmt"
	"log"

	"github.com/hashicorp/terraform-plugin-sdk/v2/helper/resource"
	"github.com/hashicorp/terraform-plugin-sdk/v2/helper/schema"
	teo "github.com/tencentcloud/tencentcloud-sdk-go/tencentcloud/teo/v20220901"

	tccommon "github.com/tencentcloudstack/terraform-provider-tencentcloud/tencentcloud/common"
	"github.com/tencentcloudstack/terraform-provider-tencentcloud/tencentcloud/internal/helper"
	svctag "github.com/tencentcloudstack/terraform-provider-tencentcloud/tencentcloud/services/tag"
)

func ResourceTencentCloudTeoZone() *schema.Resource {
	return &schema.Resource{
		Create: resourceTencentCloudTeoZoneCreate,
		Read:   resourceTencentCloudTeoZoneRead,
		Update: resourceTencentCloudTeoZoneUpdate,
		Delete: resourceTencentCloudTeoZoneDelete,
		Importer: &schema.ResourceImporter{
			State: schema.ImportStatePassthrough,
		},
		Schema: map[string]*schema.Schema{
			"zone_name": {
				Type:        schema.TypeString,
				Required:    true,
				ForceNew:    true,
				Description: "Site name. When accessing CNAME/NS, please pass the second-level domain (example.com) as the site name; when accessing without a domain name, please leave this value empty.",
			},

			"type": {
				Type:        schema.TypeString,
				Required:    true,
				Description: "Site access type. The value of this parameter is as follows, and the default is partial if not filled in:partial: CNAME access; full: NS access; noDomainAccess: No domain access.",
			},

			"alias_zone_name": {
				Type:        schema.TypeString,
				Optional:    true,
				Description: "Alias site identifier. Limit the input to a combination of numbers, English, - and _, within 20 characters. For details, refer to the alias site identifier. If there is no such usage scenario, leave this field empty.",
			},

			"area": {
				Type:        schema.TypeString,
				Required:    true,
				Description: "When the Type value is partial/full, the acceleration region of the L7 domain name. The following are the values of this parameter, and the default value is overseas if not filled in. When the Type value is noDomainAccess, please leave this value empty:\n  - global: Global availability zone.\n  - mainland: Chinese mainland availability zone.\n  - overseas: Global availability zone (excluding Chinese mainland).",
			},

			"plan_id": {
				Type:        schema.TypeString,
				Required:    true,
				ForceNew:    true,
				Description: "The target Plan ID to be bound. When you have an existing Plan in your account, you can fill in this parameter to directly bind the site to the Plan. If you do not have a Plan that can be bound at the moment, please go to the console to purchase a Plan to complete the site creation.",
			},

			"paused": {
				Type:        schema.TypeBool,
				Optional:    true,
				Computed:    true,
				Description: "Indicates whether the site is disabled.",
			},

			"status": {
				Type:        schema.TypeString,
				Computed:    true,
				Description: "Site status. Valid values: `active`: NS is switched; `pending`: NS is not switched; `moved`: NS is moved; `deactivated`: this site is blocked.",
			},

			"ownership_verification": {
				Type:        schema.TypeList,
				Computed:    true,
				Description: "Ownership verification information. Note: This field may return null, indicating that no valid value can be obtained.",
				Elem: &schema.Resource{
					Schema: map[string]*schema.Schema{
						"dns_verification": {
							Type:        schema.TypeList,
							Computed:    true,
							Description: "CNAME access, using DNS to resolve the information required for authentication. For details, please refer to [Site/Domain Name Ownership Verification ](https://cloud.tencent.com/document/product/1552/70789#7af6ecf8-afca-4e35-8811-b5797ed1bde5). Note: This field may return null, indicating that no valid value can be obtained.",
							Elem: &schema.Resource{
								Schema: map[string]*schema.Schema{
									"subdomain": {
										Type:        schema.TypeString,
										Computed:    true,
										Description: "Host record.",
									},
									"record_type": {
										Type:        schema.TypeString,
										Computed:    true,
										Description: "Record type.",
									},
									"record_value": {
										Type:        schema.TypeString,
										Computed:    true,
										Description: "Record the value.",
									},
								},
							},
						},
					},
				},
			},

			"name_servers": {
				Type:        schema.TypeList,
				Computed:    true,
				Description: "NS list allocated by Tencent Cloud.",
				Elem: &schema.Schema{
					Type: schema.TypeString,
				},
			},

			"tags": {
				Type:        schema.TypeMap,
				Optional:    true,
				Description: "Tag description list.",
			},

			"work_mode_infos": {
				Type:        schema.TypeList,
				Optional:    true,
				Computed:    true,
				Description: "Configuration group work mode. Each configuration module of the site can enable version control mode or immediate effect mode according to the configuration group dimension. For details, please refer to [Version Management](https://cloud.tencent.com/document/product/1552/113690).",
				Elem: &schema.Resource{
					Schema: map[string]*schema.Schema{
						"config_group_type": {
							Type:        schema.TypeString,
							Required:    true,
							Description: "Configuration group type. Valid values: `l7_acceleration`: L7 acceleration configuration group; `edge_functions`: Edge functions configuration group.",
						},
						"work_mode": {
							Type:        schema.TypeString,
							Required:    true,
							Description: "Work mode. Valid values: `immediate_effect`: Immediate effect mode; `version_control`: Version control mode.",
						},
					},
				},
			},
		},
	}
}

func resourceTencentCloudTeoZoneCreate(d *schema.ResourceData, meta interface{}) error {
	defer tccommon.LogElapsed("resource.tencentcloud_teo_zone.create")()
	defer tccommon.InconsistentCheck(d, meta)()

	logId := tccommon.GetLogId(tccommon.ContextNil)

	ctx := tccommon.NewResourceLifeCycleHandleFuncContext(context.Background(), logId, d, meta)

	var (
		zoneId string
	)
	var (
		request  = teo.NewCreateZoneRequest()
		response = teo.NewCreateZoneResponse()
	)

	if v, ok := d.GetOk("type"); ok {
		request.Type = helper.String(v.(string))
	}

	if v, ok := d.GetOk("zone_name"); ok {
		request.ZoneName = helper.String(v.(string))
	}

	if v, ok := d.GetOk("area"); ok {
		request.Area = helper.String(v.(string))
	}

	if v, ok := d.GetOk("plan_id"); ok {
		request.PlanId = helper.String(v.(string))
	}

	if v, ok := d.GetOk("alias_zone_name"); ok {
		request.AliasZoneName = helper.String(v.(string))
	}

	err := resource.Retry(tccommon.WriteRetryTimeout, func() *resource.RetryError {
		result, e := meta.(tccommon.ProviderMeta).GetAPIV3Conn().UseTeoClient().CreateZoneWithContext(ctx, request)
		if e != nil {
			if err := resourceTencentCloudTeoZoneCreateRequestOnError0(ctx, request, e); err != nil {
				return err
			}
			return tccommon.RetryError(e)
		} else {
			log.Printf("[DEBUG]%s api[%s] success, request body [%s], response body [%s]\n", logId, request.GetAction(), request.ToJsonString(), result.ToJsonString())
		}
		response = result
		return nil
	})
	if err != nil {
		log.Printf("[CRITAL]%s create teo zone failed, reason:%+v", logId, err)
		return err
	}

	zoneId = *response.Response.ZoneId

	if err := resourceTencentCloudTeoZoneCreatePostHandleResponse0(ctx, response); err != nil {
		return err
	}

	d.SetId(zoneId)

	if tags := helper.GetTags(d, "tags"); len(tags) > 0 {
		tagService := svctag.NewTagService(meta.(tccommon.ProviderMeta).GetAPIV3Conn())
		region := meta.(tccommon.ProviderMeta).GetAPIV3Conn().Region
		resourceName := fmt.Sprintf("qcs::teo:%s:uin/:zone/%s", region, d.Id())
		if err := tagService.ModifyTags(ctx, resourceName, tags, nil); err != nil {
			return err
		}
	}

	return resourceTencentCloudTeoZoneRead(d, meta)
}

func resourceTencentCloudTeoZoneRead(d *schema.ResourceData, meta interface{}) error {
	defer tccommon.LogElapsed("resource.tencentcloud_teo_zone.read")()
	defer tccommon.InconsistentCheck(d, meta)()

	logId := tccommon.GetLogId(tccommon.ContextNil)

	ctx := tccommon.NewResourceLifeCycleHandleFuncContext(context.Background(), logId, d, meta)

	service := TeoService{client: meta.(tccommon.ProviderMeta).GetAPIV3Conn()}

	zoneId := d.Id()

	respData, err := service.DescribeTeoZoneById(ctx, zoneId)
	if err != nil {
		return err
	}

	if respData == nil {
		d.SetId("")
		log.Printf("[WARN]%s resource `teo_zone` [%s] not found, please check if it has been deleted.\n", logId, d.Id())
		return nil
	}
	if respData.ZoneName != nil {
		_ = d.Set("zone_name", respData.ZoneName)
	}

	if respData.NameServers != nil {
		_ = d.Set("name_servers", respData.NameServers)
	}

	if respData.Status != nil {
		_ = d.Set("status", respData.Status)
	}

	if respData.Type != nil {
		_ = d.Set("type", respData.Type)
	}

	if respData.Paused != nil {
		_ = d.Set("paused", respData.Paused)
	}

	if respData.Area != nil {
		_ = d.Set("area", respData.Area)
	}

	if respData.AliasZoneName != nil {
		_ = d.Set("alias_zone_name", respData.AliasZoneName)
	}

	if respData.WorkModeInfos != nil && len(respData.WorkModeInfos) > 0 {
		workModeInfosList := make([]map[string]interface{}, 0, len(respData.WorkModeInfos))
		for _, workModeInfo := range respData.WorkModeInfos {
			workModeInfoMap := make(map[string]interface{})
			if workModeInfo.ConfigGroupType != nil {
				workModeInfoMap["config_group_type"] = *workModeInfo.ConfigGroupType
			}
			if workModeInfo.WorkMode != nil {
				workModeInfoMap["work_mode"] = *workModeInfo.WorkMode
			}
			workModeInfosList = append(workModeInfosList, workModeInfoMap)
		}
		_ = d.Set("work_mode_infos", workModeInfosList)
	}

	ownershipVerificationMap := map[string]interface{}{}

	if respData.OwnershipVerification != nil {
		dnsVerificationMap := map[string]interface{}{}

		if respData.OwnershipVerification.DnsVerification != nil {
			if respData.OwnershipVerification.DnsVerification.Subdomain != nil {
				dnsVerificationMap["subdomain"] = respData.OwnershipVerification.DnsVerification.Subdomain
			}

			if respData.OwnershipVerification.DnsVerification.RecordType != nil {
				dnsVerificationMap["record_type"] = respData.OwnershipVerification.DnsVerification.RecordType
			}

			if respData.OwnershipVerification.DnsVerification.RecordValue != nil {
				dnsVerificationMap["record_value"] = respData.OwnershipVerification.DnsVerification.RecordValue
			}

			ownershipVerificationMap["dns_verification"] = []interface{}{dnsVerificationMap}
		}

		_ = d.Set("ownership_verification", []interface{}{ownershipVerificationMap})
	} else {
		_ = d.Set("ownership_verification", []interface{}{})
	}

	if err := resourceTencentCloudTeoZoneReadPostHandleResponse0(ctx, respData); err != nil {
		return err
	}

	tcClient := meta.(tccommon.ProviderMeta).GetAPIV3Conn()
	tagService := svctag.NewTagService(tcClient)
	tags, err := tagService.DescribeResourceTags(ctx, "teo", "zone", tcClient.Region, d.Id())
	if err != nil {
		return err
	}
	_ = d.Set("tags", tags)

	return nil
}

func resourceTencentCloudTeoZoneUpdate(d *schema.ResourceData, meta interface{}) error {
	defer tccommon.LogElapsed("resource.tencentcloud_teo_zone.update")()
	defer tccommon.InconsistentCheck(d, meta)()

	logId := tccommon.GetLogId(tccommon.ContextNil)

	ctx := tccommon.NewResourceLifeCycleHandleFuncContext(context.Background(), logId, d, meta)

	zoneId := d.Id()

	needChange := false
	mutableArgs := []string{"type", "alias_zone_name", "area"}
	for _, v := range mutableArgs {
		if d.HasChange(v) {
			needChange = true
			break
		}
	}

	if needChange {
		request := teo.NewModifyZoneRequest()

		request.ZoneId = &zoneId

		if v, ok := d.GetOk("type"); ok {
			request.Type = helper.String(v.(string))
		}

		if v, ok := d.GetOk("alias_zone_name"); ok {
			request.AliasZoneName = helper.String(v.(string))
		}

		if v, ok := d.GetOk("area"); ok {
			request.Area = helper.String(v.(string))
		}

		err := resource.Retry(tccommon.WriteRetryTimeout, func() *resource.RetryError {
			result, e := meta.(tccommon.ProviderMeta).GetAPIV3Conn().UseTeoClient().ModifyZoneWithContext(ctx, request)
			if e != nil {
				return tccommon.RetryError(e)
			} else {
				log.Printf("[DEBUG]%s api[%s] success, request body [%s], response body [%s]\n", logId, request.GetAction(), request.ToJsonString(), result.ToJsonString())
			}
			return nil
		})
		if err != nil {
			log.Printf("[CRITAL]%s update teo zone failed, reason:%+v", logId, err)
			return err
		}
	}

	needChange1 := false
	mutableArgs1 := []string{"paused"}
	for _, v := range mutableArgs1 {
		if d.HasChange(v) {
			needChange1 = true
			break
		}
	}

	if needChange1 {
		request1 := teo.NewModifyZoneStatusRequest()

		request1.ZoneId = &zoneId

		if v, ok := d.GetOkExists("paused"); ok {
			request1.Paused = helper.Bool(v.(bool))
		}

		err := resource.Retry(tccommon.WriteRetryTimeout, func() *resource.RetryError {
			result, e := meta.(tccommon.ProviderMeta).GetAPIV3Conn().UseTeoClient().ModifyZoneStatusWithContext(ctx, request1)
			if e != nil {
				return tccommon.RetryError(e)
			} else {
				log.Printf("[DEBUG]%s api[%s] success, request body [%s], response body [%s]\n", logId, request1.GetAction(), request1.ToJsonString(), result.ToJsonString())
			}
			if err := resourceTencentCloudTeoZoneUpdatePostRequest1(ctx, request1, result); err != nil {
				return err
			}

			return nil
		})
		if err != nil {
			log.Printf("[CRITAL]%s update teo zone failed, reason:%+v", logId, err)
			return err
		}
	}

	if d.HasChange("tags") {
		ctx := context.WithValue(context.TODO(), tccommon.LogIdKey, logId)
		tcClient := meta.(tccommon.ProviderMeta).GetAPIV3Conn()
		tagService := svctag.NewTagService(tcClient)
		oldTags, newTags := d.GetChange("tags")
		replaceTags, deleteTags := svctag.DiffTags(oldTags.(map[string]interface{}), newTags.(map[string]interface{}))
		resourceName := tccommon.BuildTagResourceName("teo", "zone", tcClient.Region, d.Id())
		if err := tagService.ModifyTags(ctx, resourceName, replaceTags, deleteTags); err != nil {
			return err
		}
	}

	if d.HasChange("work_mode_infos") {
		if v, ok := d.GetOk("work_mode_infos"); ok {
			workModeInfos := v.([]interface{})
			if len(workModeInfos) > 0 {
				request := teo.NewModifyZoneWorkModeRequest()
				request.ZoneId = &zoneId

				configGroupWorkModeInfos := make([]*teo.ConfigGroupWorkModeInfo, 0, len(workModeInfos))
				for _, item := range workModeInfos {
					workModeInfoMap := item.(map[string]interface{})
					configGroupWorkModeInfo := &teo.ConfigGroupWorkModeInfo{}

					if v, ok := workModeInfoMap["config_group_type"]; ok {
						configGroupWorkModeInfo.ConfigGroupType = helper.String(v.(string))
					}
					if v, ok := workModeInfoMap["work_mode"]; ok {
						configGroupWorkModeInfo.WorkMode = helper.String(v.(string))
					}

					configGroupWorkModeInfos = append(configGroupWorkModeInfos, configGroupWorkModeInfo)
				}
				request.WorkModeInfos = configGroupWorkModeInfos

				err := resource.Retry(tccommon.WriteRetryTimeout, func() *resource.RetryError {
					result, e := meta.(tccommon.ProviderMeta).GetAPIV3Conn().UseTeoClient().ModifyZoneWorkModeWithContext(ctx, request)
					if e != nil {
						return tccommon.RetryError(e)
					} else {
						log.Printf("[DEBUG]%s api[%s] success, request body [%s], response body [%s]\n", logId, request.GetAction(), request.ToJsonString(), result.ToJsonString())
					}
					return nil
				})
				if err != nil {
					log.Printf("[CRITAL]%s update teo zone work mode failed, reason:%+v", logId, err)
					return err
				}
			}
		}
	}

	return resourceTencentCloudTeoZoneRead(d, meta)
}

func resourceTencentCloudTeoZoneDelete(d *schema.ResourceData, meta interface{}) error {
	defer tccommon.LogElapsed("resource.tencentcloud_teo_zone.delete")()
	defer tccommon.InconsistentCheck(d, meta)()

	logId := tccommon.GetLogId(tccommon.ContextNil)
	ctx := tccommon.NewResourceLifeCycleHandleFuncContext(context.Background(), logId, d, meta)

	zoneId := d.Id()

	var (
		request  = teo.NewDeleteZoneRequest()
		response = teo.NewDeleteZoneResponse()
	)

	request.ZoneId = &zoneId

	if err := resourceTencentCloudTeoZoneDeletePostFillRequest0(ctx, request); err != nil {
		return err
	}

	err := resource.Retry(tccommon.WriteRetryTimeout, func() *resource.RetryError {
		result, e := meta.(tccommon.ProviderMeta).GetAPIV3Conn().UseTeoClient().DeleteZoneWithContext(ctx, request)
		if e != nil {
			return tccommon.RetryError(e)
		} else {
			log.Printf("[DEBUG]%s api[%s] success, request body [%s], response body [%s]\n", logId, request.GetAction(), request.ToJsonString(), result.ToJsonString())
		}
		response = result
		return nil
	})
	if err != nil {
		log.Printf("[CRITAL]%s create teo zone failed, reason:%+v", logId, err)
		return err
	}

	_ = response
	return nil
}
