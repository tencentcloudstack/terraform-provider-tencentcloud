// Code generated by iacg; DO NOT EDIT.
package tcss

import (
	"context"
	"fmt"
	"log"
	"strconv"

	tcssv20201101 "github.com/tencentcloud/tencentcloud-sdk-go/tencentcloud/tcss/v20201101"

	"github.com/hashicorp/terraform-plugin-sdk/v2/helper/resource"
	tccommon "github.com/tencentcloudstack/terraform-provider-tencentcloud/tencentcloud/common"
	"github.com/tencentcloudstack/terraform-provider-tencentcloud/tencentcloud/connectivity"
	"github.com/tencentcloudstack/terraform-provider-tencentcloud/tencentcloud/internal/helper"
	"github.com/tencentcloudstack/terraform-provider-tencentcloud/tencentcloud/ratelimit"
)

func NewTcssService(client *connectivity.TencentCloudClient) TcssService {
	return TcssService{client: client}
}

type TcssService struct {
	client *connectivity.TencentCloudClient
}

func (me *TcssService) DescribeTcssImageRegistryById(ctx context.Context, registryId string) (ret *tcssv20201101.ImageRepoRegistryInfo, errRet error) {
	logId := tccommon.GetLogId(ctx)

	request := tcssv20201101.NewDescribeAssetImageRegistryRegistryListRequest()

	defer func() {
		if errRet != nil {
			log.Printf("[CRITAL]%s api[%s] fail, request body [%s], reason[%s]\n", logId, request.GetAction(), request.ToJsonString(), errRet.Error())
		}
	}()

	ratelimit.Check(request.GetAction())

	var (
		instances []*tcssv20201101.ImageRepoRegistryInfo
		offset    uint64 = 0
		limit     uint64 = 20
	)

	for {
		request.Offset = &offset
		request.Limit = &limit
		response, err := me.client.UseTcssV20201101Client().DescribeAssetImageRegistryRegistryList(request)
		if err != nil {
			errRet = err
			return
		}
		log.Printf("[DEBUG]%s api[%s] success, request body [%s], response body [%s]\n", logId, request.GetAction(), request.ToJsonString(), response.ToJsonString())

		if response == nil || len(response.Response.List) < 1 {
			break
		}
		instances = append(instances, response.Response.List...)
		if len(response.Response.List) < int(limit) {
			break
		}

		offset += limit
	}

	if len(instances) == 0 {
		return
	}

	registryIdUint, _ := strconv.ParseUint(registryId, 10, 64)
	for _, item := range instances {
		if *item.RegistryId == registryIdUint {
			ret = item
			return
		}
	}

	return
}

func (me *TcssService) DescribeTcssClusterAccessById(ctx context.Context, clusterId string) (ret *tcssv20201101.ClusterInfoItem, errRet error) {
	logId := tccommon.GetLogId(ctx)

	request := tcssv20201101.NewDescribeUserClusterRequest()
	response := tcssv20201101.NewDescribeUserClusterResponse()
	request.Offset = helper.IntUint64(0)
	request.Limit = helper.IntUint64(1)
	request.Filters = []*tcssv20201101.ComplianceFilters{
		{
			Name:       helper.String("ClusterID"),
			Values:     helper.Strings([]string{clusterId}),
			ExactMatch: helper.Bool(true),
		},
	}

	defer func() {
		if errRet != nil {
			log.Printf("[CRITAL]%s api[%s] fail, request body [%s], reason[%s]\n", logId, request.GetAction(), request.ToJsonString(), errRet.Error())
		}
	}()

	err := resource.Retry(tccommon.ReadRetryTimeout, func() *resource.RetryError {
		ratelimit.Check(request.GetAction())
		result, e := me.client.UseTcssV20201101Client().DescribeUserCluster(request)
		if e != nil {
			return tccommon.RetryError(e)
		} else {
			log.Printf("[DEBUG]%s api[%s] success, request body [%s], response body [%s]\n", logId, request.GetAction(), request.ToJsonString(), result.ToJsonString())
		}

		if result == nil || result.Response == nil || result.Response.ClusterInfoList == nil || len(result.Response.ClusterInfoList) < 1 {
			return resource.NonRetryableError(fmt.Errorf("Describe user cluster failed, Response is nil."))
		}

		response = result
		return nil
	})

	if err != nil {
		errRet = err
		return
	}

	ret = response.Response.ClusterInfoList[0]
	return
}
